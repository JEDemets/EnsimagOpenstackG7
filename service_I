heat_template_version: 2014-10-16
parameters:
  mount:
     type: string
     default: format
  dir:
     type: string
     default: /data

resources:
  compute_instance:
    type: "OS::Nova::Server"
    properties:
      flavor: m1.small
      image: debian8 
      name: serveurI
      networks:
          - subnet: subnet1
      key_name: id-rsa
      user_data: 
         str_replace:
            template: |
               #!/bin/bash 
               wget -P /tmp https://github.com/JEDemets/EnsimagOpenstackG7/archive/application_structure.zip > /tmp/log
               apt-get install unzip >> /tmp/log
               unzip /tmp/application_structure.zip -d /tmp/app >> /tmp/log
               sh /tmp/app/EnsimagOpenstackG7-application_structure/mountdisk.sh /dev/vdb $dir$  $mount$ >> /tmp/log
               sh /tmp/app/EnsimagOpenstackG7-application_structure/MDB.sh >> /tmp/log 
            params:
               $dir$: { get_param: dir }
               $mount$: { get_param: mount }
               $volID$: { get_resource: DBStore }
  DBStore:
     type: "OS::Cinder::Volume"
     properties:
        size: 1
  volume_attachment:
     type: "OS::Cinder::VolumeAttachment"
     properties:
        volume_id: { get_resource: DBStore }
        instance_uuid: { get_resource: compute_instance }

outputs:
   serviceI_IP:
      value: {get_attr: [ compute_instance, first_address ] }
