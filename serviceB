heat_template_version: 2014-10-16

parameters:
  serveurW:
     type: string
     default: 127.0.0.1
  dbserver:
     type: string
     default: 127.0.0.1
  serveurP:
     type: string
     default: 127.0.0.1
  swift:
     type: string
     default: 127.0.0.1
  container:
     type: string
  username:
     type: string
  password:
     type: string
  tenant:
     type: string
  auth_url:
     type: string

resources:
  compute_instance: # You can name this whatever you prefer
    type: "OS::Nova::Server"
    properties:
      flavor: m1.small
      image: debian8 
      name: service_button
      networks:
          - subnet: subnet1
      key_name: id-rsa
      security_groups: ['main-sec-group']
      user_data:
         str_replace:
          template: |
            #!/bin/bash 
            wget -P /tmp https://github.com/JEDemets/EnsimagOpenstackG7/archive/application_structure.zip > /tmp/log
            apt-get install unzip >> /tmp/log
            unzip /tmp/application_structure.zip -d tmp/app >> /tmp/log
            sh /tmp/app/EnsimagOpenstackG7-application_structure/button.sh $serveurW$ $serveurP$ $dbserver$ $swift$ $container$ $user $password$ $tenant$ $auth_url$ >> /tmp/log
          params:
            $serveurW$: { get_param: serveurW }
            $dbserver$: { get_param: dbserver }
            $serveurP$: { get_param: serveurP }
            $swift$ : { get_param: swift }
            $container$: { get_param: container }
            $user$: { get_param: username }
            $password$: { get_param: password }
            $tenant$:  { get_param: tenant }
            $auth_url$: { get_param: auth_url }


outputs:
   buttonIP:
      value: {get_attr: [ compute_instance, first_address ] }
