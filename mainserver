heat_template_version: 2014-10-16

parameters:
  serveurI:
     type: string
     default: 127.0.0.1
  serveurB:
     type: string
     default: 127.0.0.1
  serveurS:
     type: string
     default: 127.0.0.1
  serveurP:
     type: string
     default: 127.0.0.1

resources:
  compute_instance: # You can name this whatever you prefer
    type: "OS::Nova::Server"
    properties:
      flavor: m1.small
      image: debian8 
      name: main
      networks:
          - subnet: subnet2
      key_name: id-rsa
      security_groups: ['main-sec-group']
      user_data:
         str_replace:
          template: |
            #!/bin/bash 
            wget -P /tmp https://github.com/JEDemets/EnsimagOpenstackG7/archive/application_structure.zip > /tmp/log
            apt-get install unzip >> /tmp/log
            unzip /tmp/application_structure.zip -d /tmp/app >> /tmp/log
            sh /tmp/app/EnsimagOpenstackG7-application_structure/host.sh $serveurI$ $serveurB$ $serveurS$ $serveurP$ >> /tmp/log
            sh /tmp/app/EnsimagOpenstackG7-application_structure/main.sh >> /tmp/log
          params:
            $serveurI$: { get_param: serveurI }
            $serveurB$: { get_param: serveurB }
            $serveurS$: { get_param: serveurS }
            $serveurP$: { get_param: serveurP }

  ipfloat:
    type: "OS::Neutron::FloatingIP"
    properties:
       floating_network_id: external-network
  assoc:
    type: "OS::Nova::FloatingIPAssociation"
    properties:
       floating_ip: {get_resource: ipfloat}
       server_id: {get_resource: compute_instance}

outputs:
   instanceIP:
      value: {get_attr: [ ipfloat, floating_ip_address ] }
